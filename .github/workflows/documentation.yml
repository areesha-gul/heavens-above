name: Documentation Deployment

on:
  push:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'README.md'
      - '.github/workflows/documentation.yml'
  workflow_dispatch:
  schedule:
    # Weekly documentation rebuild
    - cron: '0 2 * * 0'

env:
  NODE_VERSION: '20.x'

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install dependencies
      run: npm install

    - name: Create documentation directory
      run: |
        echo "Setting up documentation structure..."
        mkdir -p docs/build

    - name: Generate API documentation
      run: |
        echo "Generating API documentation..."
        # Create basic API documentation from JavaScript files
        find . -name "*.js" ! -path "./node_modules/*" ! -path "./.git/*" ! -path "./docs/*" > docs/js-files.txt
        echo "Found JavaScript files for documentation:"
        cat docs/js-files.txt
        
        # Generate simple markdown documentation
        cat > docs/build/api-reference.md << 'DOC'
        # API Reference
        
        ## Project Structure
        
        This project contains the following main JavaScript files:
        
        DOC
        
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            echo "### $(basename "$file")" >> docs/build/api-reference.md
            echo "" >> docs/build/api-reference.md
            echo "**Location:** $file" >> docs/build/api-reference.md
            echo "" >> docs/build/api-reference.md
            echo "```javascript" >> docs/build/api-reference.md
            head -20 "$file" >> docs/build/api-reference.md
            echo "```" >> docs/build/api-reference.md
            echo "" >> docs/build/api-reference.md
          fi
        done < docs/js-files.txt

    - name: Generate main documentation
      run: |
        echo "Generating main documentation..."
        
        # Create main index page
        cat > docs/build/index.md << 'DOC'
        # Heavens Above - Project Documentation
        
        ## Overview
        
        This is a web scraping project for the Heavens Above website.
        
        ## Quick Start
        
        ```bash
        npm install
        node run.js
        ```
        
        ## Project Structure
        
        - `run.js` - Main application entry point
        - `package.json` - Project dependencies and configuration
        - `scripts/` - Additional utility scripts
        
        ## API Reference
        
        See [API Documentation](api-reference.md) for detailed information about the code structure.
        DOC
        
        # Copy README as project overview
        if [ -f "README.md" ]; then
          cp README.md docs/build/overview.md
          echo " - [Project Overview](overview.md)" >> docs/build/index.md
        fi
        
        echo " - [API Reference](api-reference.md)" >> docs/build/index.md
        echo "" >> docs/build/index.md
        echo "## Last Updated" >> docs/build/index.md
        echo "Documentation generated on: $(date)" >> docs/build/index.md

    - name: Generate HTML documentation
      run: |
        echo "Generating HTML documentation..."
        
        # Install a simple markdown to HTML converter
        npm install -g marked
        
        # Convert markdown to HTML
        for file in docs/build/*.md; do
          if [ -f "$file" ]; then
            html_file="docs/build/$(basename "$file" .md).html"
            echo "<!DOCTYPE html>
            <html lang='en'>
            <head>
                <meta charset='UTF-8'>
                <meta name='viewport' content='width=device-width, initial-scale=1.0'>
                <title>Heavens Above Documentation</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; max-width: 800px; margin: 0 auto; }
                    nav { background: #f4f4f4; padding: 10px; margin-bottom: 20px; border-radius: 5px; }
                    nav a { margin-right: 15px; text-decoration: none; color: #333; }
                    nav a:hover { text-decoration: underline; }
                    h1, h2, h3 { color: #333; }
                    code { background: #f4f4f4; padding: 2px 5px; border-radius: 3px; }
                    pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    .last-updated { color: #666; font-size: 0.9em; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }
                </style>
            </head>
            <body>
                <nav>
                    <a href='index.html'>Home</a>
                    <a href='api-reference.html'>API Reference</a>
                    $( [ -f "docs/build/overview.html" ] && echo "<a href='overview.html'>Project Overview</a>" )
                </nav>
            $(marked "$file")
            <div class='last-updated'>
                Documentation generated automatically by GitHub Actions
            </div>
            </body>
            </html>" > "$html_file"
          fi
        done

    - name: Upload documentation artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation-build
        path: docs/build/
        retention-days: 5

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: build-docs
    environment:
      name: github-pages
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Download documentation artifacts
      uses: actions/download-artifact@v4
      with:
        name: documentation-build
        path: docs/build

    - name: Setup GitHub Pages
      uses: actions/configure-pages@v4

    - name: Upload GitHub Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: docs/build

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Documentation deployment summary
      run: |
        echo "DOCUMENTATION DEPLOYMENT COMPLETED"
        echo "==================================="
        echo "Status: ${{ steps.deployment.outcome }}"
        echo "Documentation has been deployed to GitHub Pages"
        echo ""
        echo "Your documentation is now available at:"
        echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "Included documentation:"
        echo "- Project overview and setup instructions"
        echo "- API reference from source code"
        echo "- Automated updates on documentation changes"

  docs-health-check:
    name: Documentation Health Check
    runs-on: ubuntu-latest
    needs: deploy-docs
    if: always()
    
    steps:
    - name: Check documentation build status
      run: |
        echo "DOCUMENTATION HEALTH CHECK"
        echo "=========================="
        echo "Build job status: ${{ needs.build-docs.result }}"
        echo "Deploy job status: ${{ needs.deploy-docs.result }}"
        echo ""
        if [[ "${{ needs.build-docs.result }}" == "success" && "${{ needs.deploy-docs.result }}" == "success" ]]; then
          echo "STATUS: DOCUMENTATION DEPLOYMENT SUCCESSFUL"
          echo "All documentation has been built and deployed successfully."
        else
          echo "STATUS: DOCUMENTATION DEPLOYMENT ISSUES"
          echo "There were problems with the documentation deployment."
          echo "Please check the build logs for details."
        fi
        echo ""
        echo "Documentation URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "Last run: $(date)"

  docs-cleanup:
    name: Documentation Cleanup
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Cleanup temporary files
      run: |
        echo "Cleaning up temporary documentation files..."
        # This would remove any temporary files created during the build process
        echo "Cleanup completed"

  docs-summary:
    name: Documentation Summary
    runs-on: ubuntu-latest
    needs: [build-docs, deploy-docs, docs-health-check]
    if: always()
    
    steps:
    - name: Generate workflow summary
      run: |
        echo "DOCUMENTATION WORKFLOW SUMMARY"
        echo "=============================="
        echo "Workflow: ${{ github.workflow }}"
        echo "Trigger: ${{ github.event_name }}"
        echo "Repository: ${{ github.repository }}"
        echo "Timestamp: $(date)"
        echo ""
        echo "JOB STATUS:"
        echo "- Documentation Build: ${{ needs.build-docs.result }}"
        echo "- Documentation Deployment: ${{ needs.deploy-docs.result }}"
        echo "- Health Check: ${{ needs.docs-health-check.result }}"
        echo ""
        echo "DOCUMENTATION DETAILS:"
        echo "- Generated API reference from source code"
        echo "- Created HTML documentation with navigation"
        echo "- Deployed to GitHub Pages"
        echo "- Automatic updates on documentation changes"
        echo ""
        if [[ "${{ needs.build-docs.result }}" == "success" && "${{ needs.deploy-docs.result }}" == "success" ]]; then
          echo "FINAL STATUS: SUCCESS"
          echo "Documentation has been successfully built and deployed."
          echo "Access your documentation at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        else
          echo "FINAL STATUS: FAILED"
          echo "Documentation deployment encountered issues."
          echo "Check individual job logs for details."
        fi
