name: Code Review

on:
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Check JavaScript syntax
      run: |
        echo "Checking JavaScript syntax..."
        find . -name "*.js" ! -path "./node_modules/*" -exec node -c {} \; || echo "Syntax check completed"

  coding-standards:
    name: Coding Standards
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Check for console statements
      run: |
        echo "Checking for console statements in source code..."
        CONSOLE_FILES=$(find . -name "*.js" ! -path "./node_modules/*" ! -path "./test/*" ! -path "./tests/*" ! -path "./.github/*" -exec grep -l "console\." {} \; || true)
        
        if [ -n "$CONSOLE_FILES" ]; then
          echo "Warning: console statements found in the following files:"
          echo "$CONSOLE_FILES"
          echo "Consider removing console statements from production code."
        else
          echo "No console statements found in source files."
        fi

    - name: Check for debugger statements
      run: |
        echo "Checking for debugger statements..."
        DEBUGGER_FILES=$(find . -name "*.js" ! -path "./node_modules/*" ! -path "./.github/*" -exec grep -l "debugger" {} \; || true)
        
        if [ -n "$DEBUGGER_FILES" ]; then
          echo "Error: debugger statements found in the following files:"
          echo "$DEBUGGER_FILES"
          exit 1
        else
          echo "No debugger statements found."
        fi

    - name: Validate file naming
      run: |
        echo "Validating file naming conventions..."
        # Check for uppercase characters in file names (only warn, don't fail)
        UPPERCASE_FILES=$(find . -name "*.js" ! -path "./node_modules/*" | grep -E '[A-Z]' || true)
        
        if [ -n "$UPPERCASE_FILES" ]; then
          echo "Warning: Files with uppercase characters found:"
          echo "$UPPERCASE_FILES"
          echo "Consider using lowercase file names for consistency."
        else
          echo "All JavaScript files use proper naming conventions."
        fi
        # Don't fail the job for naming conventions - just warn
        echo "File naming validation completed (warnings only)"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Run security audit
      run: |
        echo "Running security audit on dependencies..."
        npm audit --audit-level moderate || echo "Security audit completed"

    - name: Scan for sensitive data
      run: |
        echo "Scanning for potential sensitive data..."
        # More specific patterns to avoid false positives
        SENSITIVE_DATA=$(grep -r -i -n "password[[:space:]]*=[[:space:]]*\\|secret[[:space:]]*=[[:space:]]*\\|api_key\\|private_key\\|access_token\\|refresh_token" . \
          --exclude-dir=.git \
          --exclude-dir=node_modules \
          --exclude-dir=.github \
          --exclude="*.md" \
          --exclude="*.json" \
          --exclude="*.lock" \
          --exclude="LICENSE" \
          --exclude="*.yml" \
          --exclude="*.yaml" || true)
        
        if [ -n "$SENSITIVE_DATA" ]; then
          echo "Potential sensitive data found. Please review:"
          echo "$SENSITIVE_DATA"
          exit 1
        else
          echo "No obvious sensitive data found."
        fi

    - name: Check for eval usage
      run: |
        echo "Checking for eval usage..."
        EVAL_FILES=$(find . -name "*.js" ! -path "./node_modules/*" ! -path "./.github/*" -exec grep -l "eval(" {} \; || true)
        
        if [ -n "$EVAL_FILES" ]; then
          echo "Warning: eval() usage found in the following files:"
          echo "$EVAL_FILES"
          echo "eval() is considered dangerous and should be avoided."
        else
          echo "No eval() usage found."
        fi

  code-metrics:
    name: Code Metrics
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Calculate code statistics
      run: |
        echo "Calculating code statistics..."
        
        # Count lines of code
        TOTAL_LINES=$(find . -name "*.js" ! -path "./node_modules/*" -exec cat {} \; | wc -l || echo "0")
        TOTAL_FILES=$(find . -name "*.js" ! -path "./node_modules/*" | wc -l || echo "0")
        
        echo "Code Statistics:"
        echo "Total JavaScript files: $TOTAL_FILES"
        echo "Total lines of code: $TOTAL_LINES"
        
        # Calculate average lines per file
        if [ $TOTAL_FILES -gt 0 ]; then
          AVG_LINES=$((TOTAL_LINES / TOTAL_FILES))
          echo "Average lines per file: $AVG_LINES"
        fi
        
        # Check for large files (informational only)
        echo "Large files (over 200 lines):"
        find . -name "*.js" ! -path "./node_modules/*" -exec wc -l {} \; | awk '$1 > 200' | sort -nr || echo "No large files found"

  test-validation:
    name: Test Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies
      run: npm install

    - name: Run tests
      run: |
        echo "Running test suite..."
        npm test || echo "Tests completed"

  pr-analysis:
    name: PR Analysis
    runs-on: ubuntu-latest
    needs: [code-analysis, coding-standards, security-scan, code-metrics, test-validation]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate PR report
      run: |
        echo "Generating Code Review Report for PR #${{ github.event.pull_request.number }}"
        echo "================================================================"
        echo "Pull Request: ${{ github.event.pull_request.title }}"
        echo "Author: ${{ github.event.pull_request.user.login }}"
        echo "Branch: ${{ github.event.pull_request.head.ref }} -> ${{ github.event.pull_request.base.ref }}"
        echo "================================================================"
        echo ""
        echo "CODE REVIEW SUMMARY"
        echo "==================="
        echo "Code Analysis: ${{ needs.code-analysis.result }}"
        echo "Coding Standards: ${{ needs.coding-standards.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        echo "Code Metrics: ${{ needs.code-metrics.result }}"
        echo "Test Validation: ${{ needs.test-validation.result }}"
        echo ""
        
        # Determine overall status
        if [[ "${{ needs.code-analysis.result }}" == "success" && \
              "${{ needs.coding-standards.result }}" == "success" && \
              "${{ needs.security-scan.result }}" == "success" && \
              "${{ needs.test-validation.result }}" == "success" ]]; then
          echo "OVERALL STATUS: ALL CHECKS PASSED"
          echo "This PR meets all code quality standards and is ready for review."
        else
          echo "OVERALL STATUS: SOME CHECKS FAILED"
          echo "Please address the issues above before merging."
        fi
        
        echo ""
        echo "RECOMMENDATIONS:"
        echo "1. Review any security warnings"
        echo "2. Address coding standard violations"
        echo "3. Ensure all tests pass"
        echo "4. Verify no sensitive data is exposed"
        echo ""
        echo "Report generated at: $(date)"

    - name: Comment on PR
      uses: actions/github-script@v7
      if: always()
      with:
        script: |
          const codeAnalysis = context.job.needs['code-analysis'];
          const codingStandards = context.job.needs['coding-standards'];
          const securityScan = context.job.needs['security-scan'];
          const codeMetrics = context.job.needs['code-metrics'];
          const testValidation = context.job.needs['test-validation'];
          
          const allPassed = 
            codeAnalysis.result === 'success' &&
            codingStandards.result === 'success' && 
            securityScan.result === 'success' &&
            testValidation.result === 'success';
          
          const commentBody = `
          Automated Code Review Report
          
          Check Results
          - Code Analysis: ${codeAnalysis.result === 'success' ? 'Passed' : 'Failed'}
          - Coding Standards: ${codingStandards.result === 'success' ? 'Passed' : 'Failed'} 
          - Security Scan: ${securityScan.result === 'success' ? 'Passed' : 'Failed'}
          - Test Validation: ${testValidation.result === 'success' ? 'Passed' : 'Failed'}
          - Code Metrics: ${codeMetrics.result === 'success' ? 'Passed' : 'Completed'}
          
          Summary
          ${allPassed ? 
            'All automated checks passed! This PR is ready for human review.' :
            'Some checks failed. Please review the failed checks above before merging.'
          }
          
          Next Steps
          1. Review any security warnings
          2. Address coding standard violations  
          3. Ensure all tests pass
          4. Verify code complexity is manageable
          5. Human review recommended
          
          Report generated by GitHub Actions`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
          });

  required-checks:
    name: Required Checks
    runs-on: ubuntu-latest
    needs: [code-analysis, coding-standards, security-scan, test-validation]
    if: always()
    
    steps:
    - name: Verify required checks
      run: |
        echo "Required checks verification:"
        echo "- Code Analysis: ${{ needs.code-analysis.result }}"
        echo "- Coding Standards: ${{ needs.coding-standards.result }}"
        echo "- Security Scan: ${{ needs.security-scan.result }}"
        echo "- Test Validation: ${{ needs.test-validation.result }}"
        
        # Only fail on critical issues, not warnings
        if [[ "${{ needs.code-analysis.result }}" == "success" && \
              "${{ needs.security-scan.result }}" == "success" && \
              "${{ needs.test-validation.result }}" == "success" ]]; then
          echo "All critical checks passed!"
          echo "Note: Some coding standards may have warnings but are not blocking."
          exit 0
        else
          echo "Critical checks failed. Please address the issues."
          exit 1
        fi
