name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      dependency-type:
        description: 'Type of dependencies to update'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - production
        - development
      update-level:
        description: 'Update level'
        required: false
        default: 'minor'
        type: choice
        options:
        - patch
        - minor
        - major

jobs:
  dependency-scan:
    name: Scan for Dependency Updates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install npm-check-updates
      run: npm install -g npm-check-updates

    - name: Install dependencies for scanning
      run: npm install --package-lock-only

    - name: Scan for available updates
      run: |
        echo "Scanning for dependency updates..."
        
        # Check for updates using ncu
        ncu > ncu-output.txt
        
        # Count updates by looking for the arrow symbol
        UPDATE_COUNT=$(grep -c "→" ncu-output.txt || echo "0")
        
        if [ "$UPDATE_COUNT" -gt 0 ]; then
          echo "Found $UPDATE_COUNT dependency updates"
          echo "Available updates:"
          cat ncu-output.txt
        else
          echo "All dependencies are up to date"
        fi

    - name: Upload scan results
      uses: actions/upload-artifact@v4
      with:
        name: dependency-scan-$(date +%Y-%m-%d)
        path: ncu-output.txt
        retention-days: 30

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install npm-check-updates
      run: npm install -g npm-check-updates

    - name: Configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Create update branch
      run: |
        branch_name="deps/updates-$(date +%Y%m%d)"
        echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV
        git checkout -b $branch_name

    - name: Update dependencies
      id: update-deps
      run: |
        echo "Updating dependencies..."
        
        # Update dependencies
        ncu --upgrade
        
        # Check if updates were made
        if git diff --quiet package.json; then
          echo "No updates available"
          echo "updates-applied=false" >> $GITHUB_OUTPUT
          exit 0
        else
          echo "Updates applied successfully"
          echo "updates-applied=true" >> $GITHUB_OUTPUT
        fi

    - name: Install updated dependencies
      if: steps.update-deps.outputs.updates-applied == 'true'
      run: npm install

    - name: Check if test script exists
      id: check-test
      if: steps.update-deps.outputs.updates-applied == 'true'
      run: |
        if npm run | grep -q " test "; then
          echo "test-exists=true" >> $GITHUB_OUTPUT
        else
          echo "test-exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Run tests if available
      if: steps.update-deps.outputs.updates-applied == 'true' && steps.check-test.outputs.test-exists == 'true'
      run: |
        echo "Running tests with updated dependencies..."
        npm test

    - name: Skip tests if not available
      if: steps.update-deps.outputs.updates-applied == 'true' && steps.check-test.outputs.test-exists == 'false'
      run: |
        echo "No test script found in package.json - skipping tests"
        echo "Consider adding a test script to ensure dependency updates don't break your project"

    - name: Build project as alternative validation
      if: steps.update-deps.outputs.updates-applied == 'true'
      run: |
        echo "Building project to validate dependency updates..."
        # Try common build scripts, continue if they don't exist
        npm run build || npm run compile || echo "No build script found"

    - name: Create pull request for updates
      if: steps.update-deps.outputs.updates-applied == 'true'
      run: |
        echo "Creating pull request for dependency updates..."
        
        # Force add package-lock.json if it's ignored
        git add -f package.json package-lock.json
        
        git commit -m "chore(deps): update dependencies"
        git push origin ${{ env.BRANCH_NAME }}
        
        # Determine test status for PR description
        if [ "${{ steps.check-test.outputs.test-exists }}" = "true" ]; then
          TEST_STATUS="✅ Tests passed with updated dependencies"
        else
          TEST_STATUS="⚠️ No tests configured - manual verification recommended"
        fi
        
        # Create PR using GitHub CLI
        gh pr create \
          --title "Dependency Updates $(date +%Y-%m-%d)" \
          --body "Automated dependency updates.
          
          ## Changes
          - Updated dependency versions
          - Automated via GitHub Actions
          
          ## Verification
          $TEST_STATUS
          - Project builds successfully
          - Manual review recommended
          
          ## Next Steps
          - Review changelogs for updated packages
          - Run additional integration tests if needed
          - Merge if all checks pass" \
          --base main \
          --head ${{ env.BRANCH_NAME }} \
          --label "dependencies" \
          --assignee "${{ github.actor }}"

  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install dependencies and generate lockfile
      run: |
        echo "Installing dependencies to generate lockfile..."
        npm install --package-lock-only

    - name: Run security audit
      run: |
        echo "Running security audit..."
        npm audit --audit-level high

    - name: Fix security vulnerabilities
      run: |
        echo "Attempting to fix security vulnerabilities..."
        npm audit fix

    - name: Check if security fixes were applied
      id: check-security-fixes
      run: |
        # Check if fixes were applied
        if git diff --quiet package.json package-lock.json; then
          echo "No security fixes to apply"
          echo "fixes-applied=false" >> $GITHUB_OUTPUT
        else
          echo "Security fixes applied successfully"
          echo "fixes-applied=true" >> $GITHUB_OUTPUT
        fi

    - name: Create security fix PR if changes made
      if: steps.check-security-fixes.outputs.fixes-applied == 'true'
      run: |
        echo "Creating security fix pull request..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        branch_name="deps/security-fixes-$(date +%Y%m%d)"
        git checkout -b $branch_name
        git add -f package.json package-lock.json
        git commit -m "fix(security): address vulnerability issues"
        git push origin $branch_name
        
        # Create high-priority PR for security fixes
        gh pr create \
          --title "Security Vulnerability Fixes $(date +%Y-%m-%d)" \
          --body "URGENT: Security vulnerability fixes.
          
          ## Changes
          - Applied security patches for vulnerable dependencies
          - Automated via npm audit fix
          
          ## Priority: HIGH
          - Addresses critical security vulnerabilities
          - Requires immediate review and merge" \
          --base main \
          --head $branch_name \
          --label "dependencies,security,high-priority" \
          --assignee "${{ github.actor }}"

  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, update-dependencies, security-updates]
    if: always()
    
    steps:
    - name: Generate summary report
      run: |
        echo "DEPENDENCY UPDATE WORKFLOW SUMMARY"
        echo "=================================="
        echo "Workflow: ${{ github.workflow }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "Trigger: ${{ github.event_name }}"
        echo "Timestamp: $(date)"
        echo ""
        echo "UPDATE JOBS:"
        echo "- Dependency Scan: ${{ needs.dependency-scan.result }}"
        echo "- Update Dependencies: ${{ needs.update-dependencies.result }}"
        echo "- Security Updates: ${{ needs.security-updates.result }}"
        echo ""
        echo "NEXT ACTIONS:"
        echo "1. Review created pull requests in GitHub"
        echo "2. Check test results and build status"
        echo "3. Merge updates if all checks pass"
        echo ""
        echo "Workflow execution completed"
